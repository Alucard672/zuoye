# 云开发配置指南

## 🚀 云开发环境配置

### 1. 环境准备
您的云开发环境ID：`bbs-4g91m08ha404f7d0`

### 2. 云函数部署步骤

#### 步骤一：安装依赖
在微信开发者工具中：
1. 右键点击 `cloudfunctions/imageProcess` 文件夹
2. 选择"在终端中打开"
3. 运行命令：
```bash
npm install
```

对 `cloudfunctions/batchImageProcess` 重复相同操作。

#### 步骤二：部署云函数
1. 右键点击 `cloudfunctions/imageProcess` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

对 `cloudfunctions/batchImageProcess` 重复相同操作。

### 3. 云存储配置

#### 创建存储桶结构
在云开发控制台的存储管理中，创建以下文件夹：
- `original/` - 存储原始图片
- `processed/` - 存储处理后的图片

#### 设置访问权限
在存储安全规则中添加：
```javascript
{
  "read": true,
  "write": "auth != null"
}
```

### 4. 数据库配置（可选）

如需记录处理历史，可创建集合：
- `processHistory` - 处理记录
- `userStats` - 用户统计

## 📋 功能测试清单

### 基础功能测试
- [ ] 云开发环境初始化成功
- [ ] 图片上传到云存储成功
- [ ] 单张图片处理功能正常
- [ ] 批量图片处理功能正常
- [ ] 处理后图片下载正常

### 性能测试
- [ ] 小图片（<1MB）处理时间 <15秒
- [ ] 中等图片（1-3MB）处理时间 <30秒
- [ ] 大图片（3-10MB）处理时间 <60秒

### 异常处理测试
- [ ] 网络断开时的错误提示
- [ ] 图片格式不支持的处理
- [ ] 图片过大时的处理
- [ ] 云函数超时的处理

## ⚙️ 高级配置

### 云函数性能优化
在云函数配置中：
- 内存：512MB（推荐）
- 超时时间：60秒
- 环境变量：可设置处理参数

### Sharp库配置
`imageProcess` 云函数使用Sharp进行图像处理，支持：
- 对比度调整
- 亮度调整
- 锐化处理
- 格式转换
- 质量压缩

### 成本优化建议
1. **合理设置云函数内存**：根据图片大小调整
2. **优化处理算法**：减少不必要的处理步骤
3. **设置存储生命周期**：定期清理临时文件
4. **使用CDN加速**：提高图片访问速度

## 🔍 故障排查

### 常见问题

#### Q1: 云函数部署失败
A: 检查：
- 网络连接是否正常
- 环境ID是否正确
- package.json依赖是否正确

#### Q2: 图片处理失败
A: 检查：
- 图片格式是否支持
- 图片大小是否超限
- 云函数日志中的错误信息

#### Q3: 处理速度慢
A: 优化：
- 调整云函数内存配置
- 检查网络连接质量
- 考虑图片预压缩

### 日志查看
在云开发控制台的云函数管理中：
1. 选择对应的云函数
2. 查看"日志"标签页
3. 分析错误信息和性能数据

## 📊 监控和维护

### 性能监控
定期检查：
- 云函数调用次数
- 平均执行时间
- 错误率统计
- 存储使用量

### 成本监控
关注：
- 云函数调用费用
- 存储空间费用
- 流量费用
- CDN费用（如使用）

### 定期维护
- 清理过期的临时文件
- 更新Sharp库版本
- 优化处理算法
- 备份重要数据

## 🎯 部署验证

完成部署后，请按以下步骤验证：

1. **环境检查**
```javascript
// 在小程序中运行
wx.cloud.callFunction({
  name: 'imageProcess',
  data: { test: true },
  success: console.log,
  fail: console.error
})
```

2. **功能测试**
- 选择一张测试图片
- 执行完整的处理流程
- 检查处理结果质量

3. **性能测试**
- 测试不同大小的图片
- 记录处理时间
- 验证并发处理能力

## 🔐 安全注意事项

### 访问权限
- 确保云函数只能被授权用户调用
- 设置合理的存储访问权限
- 定期审查权限配置

### 数据安全
- 用户图片仅用于处理，不做其他用途
- 及时清理临时文件
- 遵守数据保护法规

### 成本控制
- 设置合理的资源配额
- 监控异常调用
- 防止恶意使用

---

## ✅ 快速部署检查清单

- [ ] 云开发环境ID已配置：`bbs-4g91m08ha404f7d0`
- [ ] imageProcess 云函数已部署
- [ ] batchImageProcess 云函数已部署
- [ ] 云存储权限已配置
- [ ] 功能测试通过
- [ ] 性能测试满意
- [ ] 监控配置完成

完成以上步骤后，您的"作业清晰"小程序就具备了真正的AI图像处理能力！🎉