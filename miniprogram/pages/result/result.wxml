<!--pages/result/result.wxml-->
<view class="container">
  <!-- 结果头部 -->
  <view class="result-header">

    <text class="success-title">优化完成！</text>
    <text class="success-subtitle">图片清晰度已显著提升</text>
  </view>

  <!-- 图片对比展示 -->
  <view class="comparison-section">


    <!-- 对比模式 -->


    <!-- 优化结果模式（改为仅缩略图勾选，不展示大图） -->
    <!-- 已移除大图展示，避免页面过长 -->

    <!-- 选择拼接：勾选列表 -->
    <view class="select-section" wx:if="{{processedImages.length > 1}}">
      <view class="select-header">
        <text>选择需要拼接的图片（已选 {{selectedCount}} 张）</text>
        <text style="display:block;color:#888;font-size:24rpx;margin-top:8rpx;">提示：将按选择顺序进行拼接（先选先排）。</text>
      </view>
      <checkbox-group bindchange="onSelectChange">
        <view class="select-list">
          <block wx:for="{{processedImages}}" wx:key="index">
            <view class="select-item">
              <!-- 勾选框放到缩略图右上角 -->
              <view class="checkbox-badge">
                <checkbox value="{{index}}" checked="{{selectedMap[index]}}"></checkbox>
              </view>
              <!-- 选择序号徽标（按选择顺序显示 1、2、3…） -->
              <view class="order-badge" wx:if="{{orderMap[index]}}">{{orderMap[index]}}</view>
              <image class="select-thumb" src="{{item.processed}}" mode="aspectFill" lazy-load="true" bindtap="previewImage" data-src="{{item.processed}}"></image>
            </view>
          </block>
        </view>
      </checkbox-group>
      <button class="btn btn-primary" bindtap="stitchSelected">拼接所选</button>
      <button class="btn btn-outline" wx:if="{{stitchedPath}}" bindtap="saveStitched" style="margin-top:16rpx;">保存到相册</button>
    </view>

    <!-- 多图切换 -->

  </view>

  <!-- 优化记录（始终显示） -->
  <view class="vault-section">
    <view class="vault-header">
      <text class="vault-title" style="width: 100rpx; display: block; box-sizing: border-box; position: relative; left: 0rpx; top: 0rpx">优化记录</text>
      <view style="display:flex; align-items:center; gap:18rpx;">
        <text class="vault-sub" style="text-align: center; color: #07c160; display: block; width: 422rpx; box-sizing: border-box">已保存 {{savedList.length}} 
        （最多保留10条，超出将自动覆盖最早）</text>
        <button wx:if="{{savedList.length}}" class="btn mini clear icon-btn" size="mini" bindtap="clearVault" aria-label="清空记录" style="margin-left: 1px; width: 72rpx; height: 74rpx; display: flex; align-items: center; justify-content: center; box-sizing: border-box; left: 0rpx; top: 0rpx">
          <image class="action-icon" src="../../images/clean.png" mode="aspectFit" binderror="onIconFail"></image>
        </button>
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:if="{{!savedList.length}}" style="padding: 16rpx 8rpx; color:#999; font-size:24rpx;">
      暂无优化记录。单张优化会自动加入，拼接完成也会加入这里。
    </view>

    <view class="vault-list" wx:if="{{savedList.length}}">
      <block wx:for="{{savedList}}" wx:key="index">
        <view class="vault-item">
          <image class="vault-thumb" src="{{item.savedFilePath}}" mode="aspectFill" bindtap="openSaved" data-path="{{item.savedFilePath}}"></image>
          <view class="vault-meta">
            <text class="vault-name">{{item.name}}</text>
            <text class="vault-time">{{item.timeText}}</text>
            <view class="meta-bottom">
              <text class="vault-size">{{item.sizeText}}</text>
              <view class="vault-actions-row">
                <button class="btn mini icon-only" size="mini" bindtap="saveSavedToAlbum" data-path="{{item.savedFilePath}}" aria-label="保存到相册">
                  <block wx:if="{{usePngIcons}}">
                    <image class="action-icon" src="../../images/save-icon.png" mode="aspectFit" binderror="onIconFail"></image>
                  </block>
                  <block wx:else>⬇</block>
                </button>
                <button class="btn mini icon-only" size="mini" bindtap="forwardSaved" data-path="{{item.savedFilePath}}" aria-label="转发">
                  <block wx:if="{{usePngIcons}}">
                    <image class="action-icon" src="../../images/icon-share.png" mode="aspectFit" binderror="onIconFail"></image>
                  </block>
                  <block wx:else></block>
                </button>
              </view>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>



  <!-- 满意度评价 -->
  <view class="feedback-section">
    <view class="feedback-title">对优化效果满意吗？</view>
    <view class="rating-stars">
      <view 
        wx:for="{{5}}" 
        wx:key="index"
        class="star {{index < rating ? 'active' : ''}}"
        bindtap="setRating"
        data-rating="{{index + 1}}"
      >
        <text>★</text>
      </view>
    </view>
    <text class="rating-text" wx:if="{{rating > 0}}">{{getRatingText(rating)}}</text>
  </view>

  <!-- 底部操作 -->
  <view class="bottom-actions">
    <button class="btn btn-ghost" bindtap="processMore">
      <image src="../../images/add-icon.png" class="btn-icon"></image>
      <text>处理更多图片</text>
    </button>
    
    <button class="btn btn-ghost" bindtap="goHome">
      <image src="../../images/home-icon.png" class="btn-icon"></image>
      <text>返回首页</text>
    </button>
  </view>

  <!-- 使用提示 -->
  <view class="tips-section">
    <view class="tips-title">💡 打印建议</view>
    <view class="tips-content">
      <text class="tip-item">• 建议使用激光打印机获得最佳效果</text>
      <text class="tip-item">• 选择"高质量"打印模式</text>
      <text class="tip-item">• 使用80g以上的纸张</text>
    </view>
  </view>

  <!-- 版本号 -->
  <view class="version-footer">
    <text>版本 v{{version || '1.4.2'}}</text>
  </view>
</view>

<!-- 分享弹窗 -->
<view class="share-modal" wx:if="{{showShareModal}}" bindtap="hideShareModal">
  <view class="share-content" catchtap="stopPropagation">
    <view class="share-header">
      <text class="share-title">分享优化结果</text>
      <view class="close-btn" bindtap="hideShareModal">×</view>
    </view>
    <view class="share-options">
      <view class="share-option" bindtap="shareToFriend">
        <image src="../../images/friend-icon.png" class="share-icon"></image>
        <text>发送给朋友</text>
      </view>
      <view class="share-option" bindtap="shareToGroup">
        <image src="../../images/group-icon.png" class="share-icon"></image>
        <text>分享到群聊</text>
      </view>
    </view>
  </view>
</view>